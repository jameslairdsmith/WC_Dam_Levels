---
title: "Analysis of Western Cape Dam Levels"
output: md_document
---

#Analysis of Western Cape Dam Levels

Below are some calculations and visualisations of the water levels of the Dams in the Western Cape  (WC) province of South Africa.

The data is gathered from the City of Cape Town data portal and cleaned in a separate script. I have uploaded the cleaned version of the data to github where it can be extracted.


##Load Dependencies

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(lubridate)
library(knitr)
library(forcats)
```


##Data Import

```{r}
StorageLong<-read.csv("Data/Clean_WC_Dam_Levels.csv",stringsAsFactors = F) %>% 
  mutate(Date=ymd(Date)) 

StorageLong %>% 
  head(10) %>% 
  kable()
```


##What are the largest dams and their capacities?

```{r, fig.height=5, fig.width=7}
StorageLong %>% 
  select(Dam,Capacity) %>% 
  distinct() %>% 
  arrange(desc(Capacity)) %>% 
  ggplot() +
  geom_col(aes(x=fct_rev(fct_reorder(Dam,Capacity)),y=Capacity)) +
  theme(axis.text.x = element_text(angle=45,vjust = 1,hjust = 1)) +
  xlab("Dams") +
  ylab("Capacity ('000)") +
  scale_y_continuous(labels = function(x){x/1000}) +
  labs(title = "Wester Cape dam capacities") +
  labs(caption = "Source: City of Cape Town")
```

You can see from the chart that the majority of the capacity is housed in 6 dams. These are generally referred to as the 'Big Six'

```{r}
BigSixCapacities<-StorageLong %>% 
  select(Dam,Capacity) %>% 
  distinct() %>% 
  arrange(desc(Capacity)) %>% 
  mutate(Dam=fct_lump(fct_rev(fct_reorder(Dam,Capacity)),6,ties.method = "first")) %>% 
  group_by(Dam) %>% 
  summarise(Capacity=sum(Capacity,na.rm=T))

write.csv(BigSixCapacities,file = "Data/BigSixCapacities.csv")

BigSixCapacities %>% 
  kable()
```

##Releveling Factors

Some of the analysis is made simpler by lumping the smaller dam levels together into a single factor.

```{r}
StorageLong %>% 
  select(Dam,Capacity) %>% 
  distinct() %>% 
  arrange(desc(Capacity)) %>% 
  mutate(Dam_Other=fct_lump(fct_reorder(Dam,Capacity,.desc = T),6,ties.method = "first")) %>% 
  kable()
```


##Showing seasonal changes

Here is a plot of the seasonal changes.

```{r, fig.width=8, message=FALSE, warning=FALSE}
StorageLong %>% 
  mutate(Dam_Other=fct_lump(fct_reorder(Dam,Capacity,.desc = T),6,ties.method = "first")) %>% 
  mutate(Year=year(Date),Month=month(Date)) %>% 
  group_by(Dam,Year,Month,Dam_Other) %>% 
  summarise(PercentTotalCapacity=median(PercentTotalCapacity,na.rm=T),Date=median(Date,na.rm=T)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_area(aes(x=Date,y=PercentTotalCapacity,fill=Dam_Other),position = "stack") +
  scale_fill_grey() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_date(date_breaks =  "1 year",date_labels = "%Y") +
  ylab("Percent Capacity") +
  guides(fill=guide_legend(title = "Dam")) 
```

```{r}
SeasonalMonthData<-StorageLong %>% 
  mutate(Dam_Other=fct_lump(fct_reorder(Dam,Capacity,.desc = T),6,ties.method = "first")) %>% 
  mutate(Year=year(Date),Month=month(Date)) %>% 
  group_by(Dam,Year,Month,Dam_Other,Capacity) %>% 
  summarise(PercentTotalCapacity=median(PercentTotalCapacity,na.rm=T),Date=median(Date,na.rm=T))

write.csv(SeasonalMonthData,file="Data/SeasonalMonthData.csv")

SeasonalMonthData %>% 
  head(10) %>% 
  kable()
```



```{r, message=FALSE, warning=FALSE}
StorageLong %>% 
  arrange(desc(Capacity)) %>% 
  ungroup() %>% 
  mutate(Dam=fct_lump(fct_rev(fct_reorder(Dam,Capacity)),n=6,ties.method = "first")) %>% 
  filter(Dam!="Other") %>% 
  group_by(Date) %>% 
  summarise(Storage=sum(Storage,na.rm=T)) %>% 
  mutate(ChangeInStorage=(Storage-lag(Storage))/Storage) %>%
  arrange(ChangeInStorage) %>% 
  mutate(Month=month(Date)) %>% 
  ggplot(aes(x=Month,y=ChangeInStorage)) +
  geom_boxplot(aes(group=Month)) +
  scale_x_continuous(breaks = 1:12) +
  scale_y_continuous(limits = c(-0.015,0.025),labels = scales::percent) +
  ylab("Daily change in capacity (Big Six)")
```

```{r, message=FALSE, warning=FALSE}
StorageLong %>% 
  arrange(desc(Capacity)) %>% 
  ungroup() %>% 
  mutate(Dam=fct_lump(fct_rev(fct_reorder(Dam,Capacity)),n=6,ties.method = "first")) %>% 
  filter(Dam!="Other") %>% 
  group_by(Date) %>% 
  summarise(Storage=sum(Storage,na.rm=T)) %>% 
  mutate(ChangeInStorage=(Storage-lag(Storage))/Storage) %>%
  arrange(ChangeInStorage) %>% 
  mutate(Week=week(Date)) %>% 
  ggplot(aes(x=Week,y=ChangeInStorage)) +
  geom_boxplot(aes(group=Week)) +
  scale_x_continuous(breaks = 1:54) +
  scale_y_continuous(limits = c(-0.015,0.025))
```

```{r}
StorageLong %>% 
  arrange(desc(Capacity)) %>% 
  ungroup() %>% 
  mutate(Dam=fct_lump(fct_rev(fct_reorder(Dam,Capacity)),n=6,ties.method = "first")) %>% 
  filter(Dam!="Other") %>% 
  group_by(Date) %>% 
  summarise(Storage=sum(Storage,na.rm=T)) %>% 
  mutate(ChangeInStorage=(Storage-lag(Storage,n = 365))) %>% 
  filter(!is.na(ChangeInStorage)) %>% 
  filter(Storage!=0) %>% 
  ggplot(aes(x=Date,y=ChangeInStorage))+
  geom_line(na.rm = T)

```

```{r}
StorageLong %>% 
  arrange(desc(Capacity)) %>% 
  ungroup() %>% 
  mutate(Dam=fct_lump(fct_rev(fct_reorder(Dam,Capacity)),n=6,ties.method = "first")) %>% 
  filter(Dam!="Other") %>% 
  group_by(Date) %>% 
  summarise(Storage=sum(Storage,na.rm=T)) %>% 
  mutate(DateDayMonth=make_date(1990, month(Date), day(Date))) %>% 
  group_by(DateDayMonth) %>% 
  mutate(AvrStorage=median(Storage,na.rm=T)) %>% 
  mutate(StorageDiff=(Storage-AvrStorage)) %>% 
  filter(!is.na(DateDayMonth)) %>% 
  filter(Storage!=0) %>% 
  #View()
  ggplot(aes(x=Date,y=StorageDiff)) +
  geom_line(na.rm = T) +
  scale_x_date(date_breaks = "1 year",date_labels  = "%Y") +
  scale_y_continuous(labels = function(x){x/1000}) +
  ylab("Capacity difference from median at time of year ('000)") 

```


